Machine Learning Versioning Tools - mlvtools
============================================
Public repository for versioning machine learning data

Convention
----------

**Step metadata**: in this document it refers to the first code cell when it
is used to declare metadata such as parameters, dvc inputs/outputs, etc.

**Work directory**: the git top level directory of the project to version.
(If the project does not use git, which is not recommended, use --working-dir
 argument on each command call)


Tools
-----

**ipynb_to_python**: this command convert a given *Jupyter Notebook* to a
parameterized and executable *Python3 script* (see specific syntax in section below)

    ipynb_to_python -n [notebook_path] -o [python_script_path]
    
**script_to_cmd**: this command create a dvc command which call the script generated by ipynb_to_python.  

    script_to_cmd -i [python_script] --out-py-cmd [python_command] \
                  --out-bash-cmd [dvc_command]
    
Configuration
-------------

A configuration file can be provided, but it is not mandatory. 
It's default location is in the **working directory**, ie `[working_dir]/.mlvtools`. 
But it can be in a custom file provided as a command argument.

The configuration file format is JSON

    {
    "path": {
    	"python_script_root_dir": "[path_to_the_script_directory]",
    	"dvc_cmd_root_dir": "[path_to_the_dvc_cmd_directory]"
    	}
    "ignore_keys: ["keywords", "to", "ignore"],
    'dvc_var_python_cmd_path': 'MLV_PY_CMD_PATH_CUSTOM',
    'dvc_var_python_cmd_name': 'MLV_PY_CMD_NAME_CUSTOM',
    }

All given path must be relative to the **working directory**

- *path_to_the_script_directory*: is the directory where **Python 3** script will be generated using 
**ipynb_to_script** command. The **Python 3** script name is based on the notebook name.

        ipynb_to_script -n ./data/My\ Notebook.ipynb 
        
        Generated script: `[path_to_the_script_directory]/my_notebook.py`
        
- *path_to_the_dvc_cmd_directory*: is the directorie where **DVC** commands will be generated using 
**script_to_cmd** command. 
Generated command names are based on **Python 3** script name.

        script_to_cmd -i ./scripts/my_notebook.py
        
        Generated commands: `[path_to_the_python_cmd_directory]/my_notebook_dvc`
                
- *ignore_keys*: list of keyword use to discard a cell. Default value is *['# No effect ]*.
    (See *Discard cell* section)
                          
- *dvc_var_python_cmd_path*, *dvc_var_python_cmd_name*: allow to customize variable names which can be used in 
**dc-cmd** Docstring parameter. They respectively correspond to the variables holding the python command file path and 
 file    name. Default values are 'MLV_PY_CMD_PATH' and 'MLV_PY_CMD_NAME'. 
(See DVC Command/Complex cases section for usage) 


Jupyter Notebook syntax
-----------------------

The **Step metadata** cell is used to declare script parameters and **dvc** outputs and dependencies.
This can be done using basic docstring syntax. This docstring must be the first statement is this cell, only
comments can be writen above. 


### Good practices 

Avoid using relative paths in your Jupyter Notebook because they are relative to 
the notebook location which not be the same when it will be converted to a script.


### Parameterize

Parameter can be declared in the **Jupyter Notebook** using basic docstring syntax.
Those parameter description is used to generate parameterized and executable python scripts.

Parameters declaration in **Jupyter Notebook**:

**Jupyter Notebook**: process_files.ipynb

    
    #:param [type]? [param_name]: [description]?
    """
    :param str input_file: the input file
    :param output_file: the output_file
    :param rate: the learning rate
    :param int retry:
    """
    
Generated **Python3 script**:

    [...]
    def process_file(input_file: str, output_file, rate, retry:int):
        """
         ...
        """
    [...]

Script command line parameters:

    my_script.py -h
    
    usage: my_cmd [-h] --input-file INPUT_FILE --output-file OUTPUT_FILE --rate
                 RATE --retry RETRY
    
    Command for script [script_name]
    
    optional arguments:
      -h, --help            show this help message and exit
      --input-file INPUT_FILE
                            the input file
      --output-file OUTPUT_FILE
                            the output_file
      --rate RATE           the rate
      --retry RETRY

All declared arguments are required.

### DVC command

The generation of this command is optional.

It is based on data declared in **notebook metadata**,
 2 modes are available:
    - describe only input/output for simple cases
    - describe full command fro complex cases

#### Simple cases

Syntax
    
    :param str input_csv_file: Path to input file
    :param str output_csv_file: Path to output file
    [...]
    
    [:dvc-[in|out][\s{related_param}]?:[\s{file_path}]?]*
    [:dvc-extra: {python_other_param}]?
    
    :dvc-in: ./data/filter.csv
    :dvc-in input_csv_file: ./data/info.csv    
    :dvc-out: ./data/train_set.csv    
    :dvc-out output_csv_file: ./data/test_set.csv
    :dvc-extra: --mode train --rate 12
       
Provided **{file_path}** path can be absolute or relative to the git top dir.

The **{related_param}** is a parameter of the corresponding python script,
 it is filled in for the python script call

The **dvc-extra** allow to declare parameter, to provide to the call of the python 
command, which are not dvc outputs or dependencies.
 
    pushd $(git rev-parse --show-toplevel)
    
    INPUT_CSV_FILE="./data/info.csv"
    OUTPUT_CSV_FILE="./data/test_set.csv"
   
    dvc run \
    -d ./data/filter.csv\
    -d $INPUT_CSV_FILE\
    -o ./data/train_set.csv\
    -o $OUTPUT_CSV_FILE\
    gen_src/python_script.py --mode train --rate 12 
            --input-csv-file $INPUT_CSV_FILE 
            --output-csv-file $OUTPUT_CSV_FILE

        
    
#### Complex cases

Syntax
    
    :dvc-cmd: {dvc_command}

    :dvc-cmd: dvc run -o ./out_train.csv -o ./out_test.csv 
        "$MLV_PY_CMD_PATH -m train --out ./out_train.csv && 
         $MLV_PY_CMD_PATH -m test --out ./out_test.csv"
    
Allow to provide the full dvc command to generate. All paths can be absolute or relative to the git top dir.
The variables $MLV_PY_CMD_PATH and $MLV_PY_CMD_NAME are available. They respectively contains the path and the name
 of the corresponding python command.
 
    pushd $(git rev-parse --show-toplevel)
    MLV_PY_CMD_PATH="gen_src/python_script.py"
    MLV_PY_CMD_NAME="python_script.py"
        
    dvc run -o ./out_train.csv \
        -o ./out_test.csv \
        "$MLV_PY_CMD_PATH -m train --out ./out_train.csv && \
        $MLV_PY_CMD_PATH -m test --out ./out_test.csv"    
    popd


### Discard cell

Some cells in **Jupyter Notebook** are executed only to watch intermediate results.
In a **Python 3** script those are statements with no effect. 
The comment **# No effect** allow to discard a whole cell content to avoid waste of 
time running those statements. It is possible to customize the list of discard keywords, see *Configuration* section.
